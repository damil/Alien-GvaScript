<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
  <head>
    <script src="../../lib/Alien/GvaScript/lib/prototype.js"></script>
    <script src="../../lib/Alien/GvaScript/lib/GvaScript.js"></script>

<script>

function msg(msg) {
  $('msgs').innerHTML += msg + "<br />" ;
}


var tree = {
  proc:{
    motif:[
      {C_MOTIF:"C1"}, 
      {C_MOTIF:"C2", TXT_MOTIF: true},
      {C_MOTIF:"C3", TXT_MOTIF:123},
      {C_MOTIF:"C4", TXT_MOTIF:456},
      {C_MOTIF:"C5"}
      ],
    partie:[
      {C_ROLE_PARTIE:"DEM", NOM_PRE_ROLE:"TOTO 1", 
       avoc: [{CLE_AVOC: 1234}, {CLE_AVOC: 5678}]},
      {C_ROLE_PARTIE:"DEF", NOM_PRE_ROLE:"TOTO 2", 
       avoc: [{CLE_AVOC: 1111}, {CLE_AVOC: 2222}, {CLE_AVOC: 3333}]},
      {C_ROLE_PARTIE:"TEM", NOM_PRE_ROLE:"TOTO 3"}
      ]
  }
};


var procForm = null;
function setup() {
  new GvaScript.Form('form', {
      datatree   : tree,

      actionsbar : {
          container :  'form.actionsbar',
          actions   : [
              {
                  label : 'Submit Form',
                  type  : 'submit'
              },
              {
                  label : 'Stop Mouse over/out handlers',
                  type  : 'button',
                  callback : function() {
                    GvaScript.Forms.get('form').unregister('input', 'mouseover');
                    GvaScript.Forms.get('form').unregister('input', 'mouseout');
                  }
              }
          ]
      },
      
      onSubmit: submit_form,

      registery: [
        ['input',             'mouseover', function(event) {event.target.style.backgroundColor = 'pink'}],
        ['input',             'mouseout',  function(event) {event.target.style.backgroundColor = 'transparent'}],
        ['input.motif-code',  'change',    function(event, newv, oldv) {msg('motif code changed from '+oldv+' -> '+newv)}],
        ['input.avocat-code', 'change',    function(event, newv, oldv) {msg('avocat code changed from '+oldv+' -> '+newv)}],
        ['input.avocat-code', 'init',      function(event, newv) {msg('avocat code initialized to '+newv)}]
      ],

      onInit: function(gva_form) { msg('form initialized. what do u wanna do?'); },
      onBeforeSubmit: function(gva_form) { return confirm('submit form??') },

      onAfterSubmit: function(gva_form, obj) { alert('form submitted successfully');msg(Object.toJSON(obj)); },
      onSubmitFailure: function(gva_form, reason) { alert('form failed to submit:\n'+reason); }, 
      onDataValidationError: function(gva_form, reason) { alert('data validation error!! '+reason); } 
    });
}

window.onload = setup;

function motif_on_add(event) {
  event.target.cells[3].innerHTML += " // " + event.target.id;
}

function submit_form(gva_form) {
  var tree = GvaScript.Form.to_tree(gva_form.formElt);

  // some validation
  if( (tree.proc.motif || []).length > 0) {
    gva_form.notify('onAfterSubmit', tree);
  }
  else {
    gva_form.notify('onSubmitFailure', 'please add at least one motif');
  }

//  var fso = new ActiveXObject("Scripting.FileSystemObject");
//  var file = fso.CreateTextFile(path, true);
//  file.Write(txt);
//  file.Close();
}


</script>

  </head>

  <body>
    <h1>Tst form with repeat and event delegation</h1>
    <ul>
      <li>Mouseove the inputs.</li>
      <li>Change Motifs Code.</li>
      <li>Submit Form</li>
      <li>Delete all Motifs, ReSubmit Form</li>
    </ul> 


<div id="msgs" style="height:100px;overflow-y:auto;border:1px solid gold;font:8pt 'courier new'"></div>

<form id="form" method="post" onsubmit="return false;">


<div id="form.actionsbar"></div>

<h2>Motifs</h2>


<table>
  <tr> 
   <td>Ix</td>
   <td>Code</td>
   <td>Texte</td>
  </tr>
  <tr repeat="motif" repeat-start="3" repeat-prefix="proc"
       onAdd="motif_on_add(event)"
       onRemove="msg(event.target.id + ' is removed')">
    <td>#{motif.count}</td>
    <td><input name="#{motif.path}.C_MOTIF" name="#{motif.path}.C_MOTIF" size="4" class="motif-code" autofocus></td>
    <td><input name="#{motif.path}.TXT_MOTIF" size="20"></td>
    <td><button onclick="GvaScript.Form.remove('#{motif.path}'); return false">
           Del
         </button></td>
  </tr>
</table>
<button onclick="GvaScript.Form.add('proc.motif'); return false">Nouveau motif</button>
<button type=button onclick="GvaScript.Form.add('proc.motif')">Nouveau motif</button>
<a href="javascript:GvaScript.Form.add('proc.motif')">Nouveau motif</a>

<div repeat="partie" repeat-prefix="proc"
       onAdd="event.target.style.border = '1px solid red'" >
<h2>Partie #{partie.count}</h2>

<table>
  <tr><td>Rôle</td>
     <td><input name="#{partie.path}.C_ROLE_PARTIE" autofocus
                  size="4"></td>
  </tr>

  <tr><td>Nom/pré</td>
     <td><input name="#{partie.path}.NOM_PRE_ROLE"
                  size="20"></td>
  </tr>

  <tr><td>Justiciable</td>
     <td><input name="#{partie.path}.CLE_PARTIE"
                  size="10"></td>
  </tr>

  <tr><td>Avocats</td>
     <td><table>
          <tr repeat="avoc" repeat-start="0">
            <td>#{avoc.count}</td>
            <td><input name="#{avoc.path}.CLE_AVOC" class="avocat-code" autofocus></td>
          </tr>
        </table>
         <button onclick="GvaScript.Form.add('#{partie.path}.avoc'); return false">
           Nouvel avocat
         </button>

     </td>
  </tr>
</table>

<button onclick="GvaScript.Form.remove('#{partie.path}'); return false">
           Del
</button>


</div><!-- fin div partie -->

<button onclick="GvaScript.Form.add('proc.partie'); return false">
  Nouvelle partie
</button>

</form>






</body>
</html>




